#dependencies:
  #install 'Java SE Development Kit 11' https://www.oracle.com/ca-en/java/technologies/javase/jdk11-archive-downloads.html
  #install 'Android Studio' https://developer.android.com/studio
  #install 'Android SDK Build-Tools', 'Android SDK Command-line Tools', 'Android Emulator', 'Android SDK Platform-Tools' from :
      #Android Studio > Tools > SDK Manager > SDK Tools
      #or Android Studio > Preferences > Appearence & Behavior > System Settings > Android SDK > SDK Tools

variables:
  android_api: "33" #android 13
  emulator_type: "apis" #atd for api < 30 more efficient
  system_architecture: "arm64-v8a" #x86_64 or x86 for Intels
  android_system_image: "system-images;android-$android_api;google_$emulator_type;$system_architecture" #'sdkmanager --list | grep system-images' to have all existing configs
  emulator_device: "pixel_6"
  emulator_name: "$emulator_device-api_$android_api-google_$emulator_type-arch_$system_architecture"


job-android-uitests:

  stage: uitests
  tags: [ "macos-xcode13" ]
  allow_failure: true

  dependencies:
    - job-android

  before_script:
    - git submodule update --init --recursive
    - mkdir logs && mkdir reports && mkdir apks
    - ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "$android_system_image" > logs/emulatorSystemImageInstallation.log
    - echo no | ${ANDROID_HOME}/cmdline-tools/latest/bin/avdmanager --verbose create avd --force --name $emulator_name --package $android_system_image --tag google_$emulator_type --abi $system_architecture --device $emulator_device > logs/emulatorCreation.log
    - ${ANDROID_HOME}/platform-tools/adb start-server
    - ${ANDROID_HOME}/emulator/emulator -avd $emulator_name &
    - .gitlab-ci-files/wait-for-android-emulator
    - ${ANDROID_HOME}/platform-tools/adb logcat -d > logs/logcats.log

  script:
    - ./gradlew -Pandroid.testInstrumentationRunnerArguments.class=org.linphone.testsuites.CallTestSuite -PscreportAutoClose=true connectedAndroidTest --continue
    - ${ANDROID_HOME}/platform-tools/adb -s emulator-5554 emu kill
    - ${ANDROID_HOME}/platform-tools/adb -s emulator-5554 emu kill
    - ${ANDROID_HOME}/platform-tools/adb kill-server

  after_script:
    - mv app/build/reports/androidTests/connected/* reports
	- mv app/build/outputs/apk/debug ./apks
    - mv app/build/outputs/apk/release ./apks
    - python3 --version
    - python3 .gitlab-ci-files/html2xml-report.py -p reports
    
  artifacts:
    paths:
      - reports/*
      - logs/*
      - apks/debug/linphone-android-debug-*.apk
      - apks/release/linphone-android-release-*.apk
    when: always
    reports:
      junit:
        - results/*.xml
    expire_in: 4 week
